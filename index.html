<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatSlovak AI V5 Model - Slovensky Chatbot</title>
    <!-- Načítanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Nastavenie fontu Inter a Tailwind farieb -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Vlastné štýly pre "sklený" efekt a tmavé pozadie */
        body {
            background-color: #10101e; /* Veľmi tmavá nočná modrá */
            background-image: linear-gradient(135deg, #10101e 0%, #08080f 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            overflow: hidden; 
        }
        /* Sklený efekt pre bočný panel */
        .glass-sidebar {
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            background-color: rgba(255, 255, 255, 0.05); 
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease-in-out;
        }
        /* Sklený efekt pre karty */
        .glass-card {
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            background-color: rgba(30, 30, 45, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease-in-out;
        }
        .glass-card:hover {
            background-color: rgba(40, 40, 55, 0.8);
            border-color: rgba(255, 255, 255, 0.2);
        }
        /* Sklený efekt pre vstup */
        .glass-input-container {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background-color: rgba(30, 30, 45, 0.85); 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        /* Štýl pre scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: rgba(255, 255, 255, 0.15); 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

        /* Mobilné menu tlačidlo */
        #menu-button { z-index: 50; }
        .modal-bg {
            background-color: rgba(16, 16, 30, 0.8);
            backdrop-filter: blur(5px);
        }

        /* Loading animation CSS - Premýšľam... */
        .dot-flashing {
            display: flex;
            align-items: center;
        }
        .dot-flashing span {
            margin-right: 8px;
            font-weight: 600;
            color: #f87171;
        }
        .dot-flashing div {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #f87171; 
            color: #f87171;
            animation: dotFlashing 1s infinite linear alternate;
            animation-delay: 0.5s;
        }
        .dot-flashing div::before, .dot-flashing div::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #f87171;
            color: #f87171;
            animation: dotFlashing 1s infinite linear alternate;
        }
        .dot-flashing div::before {
            left: -15px;
            animation-delay: 0s;
        }
        .dot-flashing div::after {
            left: 15px;
            animation-delay: 1s;
        }
        @keyframes dotFlashing {
            0% { background-color: #f87171; }
            50%, 100% { background-color: rgba(248, 113, 113, 0.2); }
        }
        
    </style>
</head>
<body class="text-white">

    <!-- Tlačidlo pre mobilné menu (Hamburger) -->
    <button id="menu-button" class="md:hidden fixed top-4 left-4 p-2 rounded-full bg-gray-800 hover:bg-gray-700 transition duration-150 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
        </svg>
    </button>

    <!-- Ľavý Bočný Panel (Sidebar) - Len pre estetiku, neimplementujeme ukladanie histórie do Firestore v tomto príklade -->
    <aside id="sidebar" class="glass-sidebar fixed md:static inset-y-0 left-0 w-64 p-4 flex flex-col justify-between transform -translate-x-full md:translate-x-0 md:shadow-xl custom-scrollbar z-40">
        <!-- Sekcia Hore -->
        <div class="space-y-4">
            <!-- Tlačidlo Nový Príbeh/Chat -->
            <button class="w-full flex items-center justify-center space-x-2 p-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl shadow-lg transition duration-200" onclick="showHomeScreen()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                <span>Nový Chat/Príbeh</span>
            </button>
            
            <!-- Konverzácie (príbehy) -->
            <div class="mt-6 text-sm space-y-2">
                <p class="text-gray-500 px-2 uppercase text-xs font-bold">História (Simulovaná)</p>
                <a href="#" class="flex items-center p-2 rounded-lg text-gray-400 hover:bg-gray-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002-2h2a2 2 0 002 2m-3 7h3m-3 4h3m-6-4h.01M10 16h.01" />
                    </svg>
                    Posledný príbeh
                </a>
            </div>
        </div>

        <!-- Sekcia Dole (Nastavenia) -->
        <div class="border-t border-gray-700 pt-4 space-y-2 text-sm">
            <p class="text-xs text-gray-500 p-2">Používateľ ID: <span id="user-id-display">Nahrávam...</span></p>
        </div>
    </aside>

    <!-- Hlavný Obsah (Main Content) -->
    <main id="main-content" class="flex-1 flex flex-col items-center justify-between p-4 md:p-8 overflow-y-auto custom-scrollbar">

        <!-- Horný Názov -->
        <header class="w-full text-center mb-8">
            <h1 class="text-4xl font-extrabold tracking-tight text-white/90">ChatSlovak AI V5 Model</h1>
            <p class="text-md text-red-400 font-medium">— AI, ktorá ti číta odpovede nahlas —</p>
        </header>

        <!-- Zobrazenie obsahu (Home/Chat) -->
        <div id="content-display" class="w-full max-w-4xl flex-1 flex flex-col justify-center items-center">
            
            <!-- Domovská obrazovka (Home Screen) -->
            <div id="home-screen" class="w-full text-center space-y-12">
                
                <h2 class="text-2xl font-semibold text-white/80 mt-12 mb-8">Ahoj! Poďme na konverzáciu alebo na rozsiahly príbeh.</h2>
                
                <!-- Sekcie Kariet / Kategórie -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Karta 1: Príbeh -->
                    <div class="glass-card p-4 rounded-xl shadow-lg hover:shadow-red-900/50 cursor-pointer" onclick="setInputPrompt('Vytvor masívne desivý, Lovecraftovský hororový príbeh o opustenom majáku na Slovensku. Intenzita 10/10.')">
                        <div class="flex items-center justify-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <h3 class="font-bold text-lg mb-1 text-red-300">Generovanie Príbehu</h3>
                        <p class="text-sm text-gray-300">Horor, Thriller, Sci-Fi. Pýtaj si dlhé a detailné výstupy.</p>
                    </div>
                    
                    <!-- Karta 2: Konverzácia/Fakty -->
                    <div class="glass-card p-4 rounded-xl shadow-lg hover:shadow-blue-500/50 cursor-pointer" onclick="setInputPrompt('Aké sú najnovšie fakty o stave umelej inteligencie? (vyhľadaj na internete)')">
                        <div class="flex items-center justify-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z" />
                            </svg>
                        </div>
                        <h3 class="font-bold text-lg mb-1 text-blue-300">Normálna Konverzácia</h3>
                        <p class="text-sm text-gray-300">Všeobecné otázky, fakty, pokec. Používa internetové dáta.</p>
                    </div>
                    
                    <!-- Karta 3: Kategórie Modal -->
                    <div class="glass-card p-4 rounded-xl shadow-lg hover:shadow-green-500/50 cursor-pointer" onclick="toggleCategoriesModal(true)">
                        <div class="flex items-center justify-center mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                            </svg>
                        </div>
                        <h3 class="font-bold text-lg mb-1 text-green-300">Prehliadať Žánre</h3>
                        <p class="text-sm text-gray-300">Inšpirácia pre generovanie dlhých textov a príbehov.</p>
                    </div>
                    
                </div>
            </div>

            <!-- Oblasť Četu (Chat Area) -->
            <!-- Zmenená štruktúra: ID chat-area teraz slúži ako obal (wrapper), scrollbar a medzery sú na #chat-messages. -->
            <div id="chat-area" class="w-full h-full flex flex-col" style="display: none;">
                <div id="chat-messages" class="flex-1 custom-scrollbar space-y-4 overflow-y-auto">
                    <!-- Úvodná správa - Presunutá do #chat-messages pre správny flow -->
                    <div class="flex justify-start">
                        <div class="p-4 rounded-xl glass-card text-sm max-w-3xl">
                            <p class="font-bold text-red-400 mb-1">ChatSlovak AI V5 Model</p>
                            <p>Systém je inicializovaný. Som pripravený viesť konverzáciu, generovať príbehy, alebo ti nájsť fakty online.</p>
                        </div>
                    </div>
                    <!-- Tu sa budú zobrazovať dynamické správy -->
                </div>
            </div>

        </div>

        <!-- Vstupný Panel -->
        <div class="w-full max-w-4xl mt-6">
            <div class="glass-input-container p-3 rounded-2xl flex items-center shadow-2xl">
                <textarea id="prompt-input" rows="1" class="flex-1 bg-transparent p-2 text-white placeholder-gray-400 resize-none outline-none custom-scrollbar" placeholder="Napíš požiadavku (príbeh) alebo otázku (konverzácia)..."></textarea>
                
                <button id="send-button" class="ml-3 p-3 bg-red-600 hover:bg-red-700 rounded-xl transition duration-200 disabled:opacity-50" onclick="generateResponse()" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
            <p class="text-xs text-gray-500 text-center mt-2">ChatSlovak AI V5.0 - Pokročilý generatívny model pre slovenský jazyk.</p>
        </div>
    </main>
    
    <!-- KATEGÓRIE MODAL -->
    <div id="categories-modal" class="fixed inset-0 z-50 modal-bg hidden items-center justify-center p-4" onclick="toggleCategoriesModal(false)">
        <div class="glass-card w-full max-w-5xl h-[80vh] p-6 rounded-3xl flex flex-col shadow-2xl" onclick="event.stopPropagation()">
            <!-- Hlavička Modalu -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-3xl font-bold text-green-300">Žánre a Inšpirácie</h3>
                <button class="p-2 text-gray-400 hover:text-white" onclick="toggleCategoriesModal(false)">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Telo Modalu s Kategóriami -->
            <div id="category-list" class="flex-1 overflow-y-auto custom-scrollbar p-3 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 content-start">
                <!-- Kategórie sa sem načítajú pomocou JS -->
            </div>
            
            <p class="text-center text-sm text-gray-500 mt-4">Kliknite na kategóriu pre vloženie požiadavky do poľa.</p>
        </div>
    </div>


    <!-- Firebase a API Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global UI Elements
        const promptInput = document.getElementById('prompt-input');
        const sendButton = document.getElementById('send-button');
        const chatArea = document.getElementById('chat-messages'); // Message container where all content is appended
        const homeScreen = document.getElementById('home-screen');
        const contentDisplay = document.getElementById('content-display');
        const sidebar = document.getElementById('sidebar');
        const menuButton = document.getElementById('menu-button');
        const categoriesModal = document.getElementById('categories-modal');
        const categoryList = document.getElementById('category-list');
        const userIdDisplay = document.getElementById('user-id-display');
        const synth = window.speechSynthesis;

        // API a Firebase konštanty
        const apiKey = "AIzaSyDdiCiIfr2gLtsRMENBkWG1hJo6N1uij7w"; // Kľúč bude poskytnutý prostredím automaticky.
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
        
        // Globálne Firebase inštancie
        let db;
        let auth;
        let currentUserId = null;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Zoznam kategórií
        const storyCategories = [
            "Horor (Psychologický)", "Sci-Fi (Dystopia)", "Fantasy (Vysoká mágia)", "Romantika (Historická)",
            "Thriller (Špionážny)", "Detektívka (Hard-boiled)", "Horor (Lovecraftovský)", "Post-apokalypsa",
            "Kyberpunk", "Komédia (Čierna)", "Cestovanie časom", "Mýtus a Legenda (Slovanské)",
            "Veda (Fakt-Fiction)", "Dráma (Súčasná)", "Noir", "Vojnový",
            "Gotický", "Satira", "Slovenský Folklór", "Dobrodružné",
            "Young Adult (Fantasy)", "Urban Fantasy", "Krimi", "Fantasy (Nízka mágia)",
            "Horor (Zombies)", "Sci-Fi (Vesmírna opera)", "Romantika (Súčasná)", "Paranormálna Romantika"
        ];
        
        /**
         * 1. FIREBASE A AUTENTIFIKÁCIA
         */
        async function initializeAppAndAuth() {
            if (firebaseConfig) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            userIdDisplay.textContent = currentUserId;
                        } else {
                            currentUserId = 'Neautorizovaný';
                            userIdDisplay.textContent = 'Neautorizovaný';
                        }
                    });

                } catch (error) {
                    console.error("Chyba pri inicializácii Firebase alebo autentifikácii:", error);
                    userIdDisplay.textContent = 'Chyba!';
                }
            } else {
                console.warn("Konfigurácia Firebase chýba. Používam lokálne UUID.");
                currentUserId = crypto.randomUUID();
                userIdDisplay.textContent = `Demo ID: ${currentUserId.substring(0, 8)}...`;
            }
        }

        /**
         * 2. UTILITY FUNKCIE
         */
        
        // Exponenciálny backoff pre fetch hovory
        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(`API Chyba: ${response.status} - ${errorData.error?.message || response.statusText}`);
                    }
                    return response.json();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    // Pokračuje v slučke pre opakovanie
                }
            }
        }

        // Ikony pre TTS
        function getSpeakerIcon(speaking) {
            if (speaking) {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400 animate-pulse" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 14.074l-.24.081a3 3 0 01-3.14-.146 3 3 0 01-1.293-2.31 3 3 0 01.373-1.463c.27-.37.587-.696.945-.968.384-.3.79-.537 1.207-.714.417-.177.85-.292 1.285-.365L9 8.001h1l-.383 6.073zM10 2a8 8 0 100 16 8 8 0 000-16zM6 9.5a.5.5 0 111 0 .5.5 0 01-1 0zm7 0a.5.5 0 111 0 .5.5 0 01-1 0z" clip-rule="evenodd" /></svg>`;
            } else {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-300 hover:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9l1.414-1.414a9 9 0 010 12.728l-1.414-1.414m-12.728.707l1.414-1.414M6.464 15.536L5.05 16.95A9 9 0 0017.68 4.318l-1.414 1.414m-1.414 1.414l-1.414 1.414M12 4v16M4 12h16" /></svg>`;
            }
        }
        
        /**
         * 3. TTS FUNKCIONALITA
         */
        window.readText = function(textElement, buttonElement) {
            const textToSpeak = textElement.textContent;
            if (!synth) { console.error("Prehliadač nepodporuje Text-to-Speech."); return; }

            if (synth.speaking) {
                synth.cancel(); 
                buttonElement.innerHTML = getSpeakerIcon(false);
                return;
            }
            
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            // Nastavenie jazyka na slovenčinu. Ak nie je k dispozícii, použije predvolený.
            utterance.lang = 'sk-SK'; 

            utterance.onend = () => { buttonElement.innerHTML = getSpeakerIcon(false); };
            utterance.onerror = (e) => console.error('Chyba pri čítaní:', e);
            
            synth.speak(utterance);
            buttonElement.innerHTML = getSpeakerIcon(true);
        }

        /**
         * 4. GENERATÍVNE API VOLANIE
         */
        async function geminiApiCall(prompt) {
            const isStoryRequest = prompt.length > 80 || 
                                   prompt.toLowerCase().includes('príbeh') || 
                                   prompt.toLowerCase().includes('vytvor') ||
                                   prompt.toLowerCase().includes('generuj');

            // System instruction je v slovenčine a prispôsobený na základe požiadavky
            const systemPrompt = isStoryRequest 
                ? "Si ChatSlovak AI V5, expert na generovanie dlhých, detailných a pútavých príbehov alebo esejí v slovenčine. Uisti sa, že tvoj výstup je v slovenčine."
                : "Si ChatSlovak AI V5. Viedni normálnu, priateľskú a vecnú konverzáciu v slovenčine. Ak odpovedáš na fakty, použi informácie z Google vyhľadávania. Odpovedaj stručne, ale komplexne.";

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                // Ak nie je požiadavka na príbeh, použijeme Google Search pre aktuálne fakty
                tools: isStoryRequest ? [] : [{ "google_search": {} }],
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const result = await exponentialBackoffFetch(API_URL, options);

            const candidate = result.candidates?.[0];
            const text = candidate?.content?.parts?.[0]?.text || "Prepáč, nepodarilo sa mi vygenerovať odpoveď. Skús preformulovať otázku.";
            const groundingMetadata = candidate?.groundingMetadata;

            return { text, groundingMetadata };
        }


        /**
         * 5. HLAVNÁ LOGIKA CHATU
         */

        // Funkcia na povolenie/zakázanie tlačidla odoslať
        promptInput.addEventListener('input', () => {
            sendButton.disabled = promptInput.value.trim() === '';
            // Auto-resize textarea
            promptInput.style.height = 'auto';
            promptInput.style.height = (promptInput.scrollHeight) + 'px';
        });

        // Event listener pre mobilné menu
        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        // Ukážeme hlavnú obrazovku a skryjeme chat
        window.showHomeScreen = function() {
            homeScreen.style.display = 'block';
            document.getElementById('chat-area').style.display = 'none';
            contentDisplay.classList.add('justify-center'); 
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
            if (synth.speaking) synth.cancel(); // Zastaví čítanie
        }
        
        // Funkcia na nastavenie promptu z kategórie
        window.setInputPrompt = function(text) {
            promptInput.value = text;
            sendButton.disabled = false; 
            promptInput.dispatchEvent(new Event('input')); 
            toggleCategoriesModal(false); 
            homeScreen.style.display = 'none';
            document.getElementById('chat-area').style.display = 'flex';
            contentDisplay.classList.remove('justify-center');
            promptInput.focus();
        }

        // Funkcia na prepínanie Modalu Kategórií
        window.toggleCategoriesModal = function(show) {
            if (show) {
                categoriesModal.style.display = 'flex';
                renderCategories(); 
            } else {
                categoriesModal.style.display = 'none';
            }
        }
        
        // Funkcia na vykreslenie kategórií
        function renderCategories() {
            categoryList.innerHTML = ''; 
            
            storyCategories.forEach(category => {
                const isStory = category.toLowerCase().includes('príbeh') || category.toLowerCase().includes('horor');
                const colorClass = isStory ? 'bg-red-900/40 border-red-500/50 hover:bg-red-800/60 text-red-300' : 'bg-green-900/30 border-green-500/50 hover:bg-green-800/50 text-green-300';
                
                const promptText = isStory 
                    ? `Vytvor masívne detailný ${category} príbeh. Daj si záležať na popise prostredia a postáv.`
                    : `Vytvor krátku esej alebo analýzu na tému: ${category}.`;

                const button = document.createElement('button');
                button.className = `p-3 text-sm font-medium rounded-lg text-left transition duration-150 border ${colorClass} shadow-md`;
                button.textContent = category;
                button.onclick = () => setInputPrompt(promptText);
                
                categoryList.appendChild(button);
            });
        }
        
        // Funkcia na generovanie odpovede (Hlavný bod)
        window.generateResponse = async function() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            if (synth.speaking) synth.cancel();

            // 1. Zobrazenie oblasti četu
            homeScreen.style.display = 'none';
            document.getElementById('chat-area').style.display = 'flex';
            contentDisplay.classList.remove('justify-center');

            // 2. Pridanie správy od používateľa
            const userMessage = createUserMessage(prompt);
            chatArea.appendChild(userMessage);

            // 3. Pridanie animácie načítania AI
            const loadingMessage = createLoadingMessage();
            chatArea.appendChild(loadingMessage);

            // Vyčistenie a zablokovanie vstupu
            promptInput.value = '';
            sendButton.disabled = true;
            promptInput.rows = 1;
            chatArea.scrollTop = chatArea.scrollHeight;

            try {
                // 4. VOLANIE API
                const { text, groundingMetadata } = await geminiApiCall(prompt);
                
                // 5. Odstránenie animácie a pridanie generovaného príbehu
                chatArea.removeChild(loadingMessage);

                const aiMessage = createAiMessage(text, 'Odpoveď Modelu', groundingMetadata);
                chatArea.appendChild(aiMessage);

            } catch (error) {
                console.error("Generovanie zlyhalo:", error);
                chatArea.removeChild(loadingMessage);
                const errorMessage = createAiMessage(`**Chyba pri generovaní:** Nastala chyba pri komunikácii s modelom. Skús preformulovať otázku.`, 'Chyba AI');
                chatArea.appendChild(errorMessage);
            } finally {
                sendButton.disabled = promptInput.value.trim() === '';
                chatArea.scrollTop = chatArea.scrollHeight;
            }
        }

        // Pomocná funkcia: Vytvorenie správy od používateľa
        function createUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'flex justify-end';
            div.innerHTML = `
                <div class="p-4 rounded-xl text-sm max-w-3xl bg-red-600/80 text-white shadow-xl">
                    ${text.split('\n').map(p => `<p>${p}</p>`).join('')}
                </div>
            `;
            return div;
        }

        // Pomocná funkcia: Vytvorenie správy od AI s TTS a možnými zdrojmi
        function createAiMessage(text, title, groundingMetadata = null) {
            const div = document.createElement('div');
            div.className = 'flex justify-start';
            
            // Nahradenie Markdown *text* za <strong>text</strong> pre lepšie zobrazenie
            const formattedText = text
                .trim()
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 

            // Spracovanie zdrojov (ak existujú)
            let sourcesHTML = '';
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                const sources = groundingMetadata.groundingAttributions
                    .map(attr => ({
                        uri: attr.web?.uri,
                        title: attr.web?.title,
                    }))
                    .filter(source => source.uri && source.title);

                if (sources.length > 0) {
                    sourcesHTML = '<div class="mt-3 pt-2 border-t border-gray-700">';
                    sourcesHTML += '<p class="text-xs text-gray-500 font-semibold mb-1">Zdroje (Internet):</p>';
                    sourcesHTML += sources.slice(0, 3).map((s, index) => 
                        `<a href="${s.uri}" target="_blank" class="text-xs text-blue-400 hover:text-blue-300 block truncate">${index + 1}. ${s.title}</a>`
                    ).join('');
                    sourcesHTML += '</div>';
                }
            }

            // Vytvorenie kontajnera s textom pre TTS
            // Používam 'pre' len pre jednoduchú štruktúru, ale nastavujem whitespace-pre-wrap
            const textContent = `<pre id="ai-text-${Date.now()}" class="font-sans text-gray-200 whitespace-pre-wrap">${formattedText}</pre>`;

            div.innerHTML = `
                <div class="p-4 rounded-xl glass-card text-sm flex flex-col shadow-2xl max-w-3xl">
                    <div class="flex justify-between items-center mb-2 pb-1 border-b border-gray-700">
                        <p class="font-bold text-red-400">${title}</p>
                        <button class="tts-button" onclick="readText(this.parentElement.nextElementSibling, this)">
                            ${getSpeakerIcon(false)}
                        </button>
                    </div>
                    ${textContent}
                    ${sourcesHTML}
                </div>
            `;
            return div;
        }

        // Pomocná funkcia: Animácia načítania "Premýšľam..."
        function createLoadingMessage() {
            const div = document.createElement('div');
            div.className = 'flex justify-start';
            div.innerHTML = `
                <div class="p-4 rounded-xl glass-card text-sm flex items-center shadow-md" id="loading-spinner">
                    <div class="dot-flashing">
                        <span>Premýšľam...</span>
                        <div></div>
                    </div>
                </div>
            `;
            return div;
        }

        // Inicializácia pri načítaní okna
        window.addEventListener('load', () => {
            initializeAppAndAuth();
            showHomeScreen();
            // Automaticky zavoláme renderCategories pre prípad, že modal niekedy použijú
            renderCategories(); 
        });
        
    </script>
</body>
</html>

