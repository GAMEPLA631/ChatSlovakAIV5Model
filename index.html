<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatSlovak AI V5 Model</title>
    <!-- Načítanie Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Nastavenie písma Inter a tmavého pozadia */
        body {
            font-family: 'Inter', sans-serif;
            color: #e4e4e7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            
            /* Tmavé pozadie s modrými a fialovými prechodmi pre moderný vzhľad */
            background-image: url('https://placehold.co/1920x1080/1a1a2e/ffffff?text=Abstract+Dark+UI'); 
            background-size: cover; 
            background-position: center;
            background-attachment: fixed;
        }

        /* Štýl pre sklenený efekt (Frosted Glass) */
        .glass-container {
            /* Mierne svetlejšie, pretože pozadie je už tmavé */
            background-color: rgba(0, 0, 0, 0.4); 
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Scrollbar styling for a cleaner look */
        .chat-area::-webkit-scrollbar {
            width: 8px;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: transparent;
        }
        
        /* Loading animation for the "Typing..." state */
        .dot-pulse {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #a8b0e0;
            animation: dotPulse 1s ease-in-out infinite;
        }

        .dot-pulse::before, .dot-pulse::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #a8b0e0;
            top: 0;
        }

        .dot-pulse::before {
            left: -15px;
            animation: dotPulseBefore 1s ease-in-out infinite;
        }

        .dot-pulse::after {
            left: 15px;
            animation: dotPulseAfter 1s ease-in-out infinite;
        }

        @keyframes dotPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.5; }
        }

        @keyframes dotPulseBefore {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.5; }
        }

        @keyframes dotPulseAfter {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.5; }
        }

        /* --- NOVÉ: Animácie pre stránku a chat --- */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Trieda pre animáciu načítania hlavného kontajnera */
        .animate-fadeInUp {
            animation: fadeInUp 0.7s ease-out;
        }

        /* Trieda pre animáciu správ v chate (pridaná priamo v JS/HTML) */
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }
        /* --- Koniec nových animácií --- */
    </style>
</head>
<body>

    <!-- Pridaná trieda animate-fadeInUp pre animáciu pri načítaní stránky -->
    <div class="glass-container w-full max-w-4xl h-[90vh] flex flex-col rounded-3xl p-6 md:p-8 m-4 animate-fadeInUp">
        
        <!-- Hlavička ChatSlovak AI -->
        <header class="mb-4 pb-4 border-b border-white/20">
            <h1 class="text-3xl font-extrabold text-blue-300 flex items-center">
                <svg class="w-8 h-8 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 17h18M5 17h14L12 3 5 17z" />
                </svg>
                ChatSlovak AI <span class="text-lg font-light ml-2 text-white/70">V5 Model</span>
            </h1>
            <p class="text-sm text-white/50">Profesionálny konverzačný partner. Píše masívne desivé príbehy. (Skúste napísať 'napíš mi hororový príbeh').</p>
        </header>

        <!-- Tlačidlá Funkcií -->
        <div class="flex justify-start mb-4">
            <button id="tts-toggle" onclick="toggleSpeaking()" class="flex items-center text-sm font-medium py-2 px-4 rounded-full transition duration-200 bg-gray-700 hover:bg-gray-600 text-white shadow-md">
                Hlas: Vypnutý
                <svg class="w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15.414a2 2 0 01-2.828-2.828m0 0a2 2 0 012.828-2.828m-2.828 2.828L5.586 15.414zM10.15 4.54a2 2 0 013.7 0M8 8a2 2 0 11-4 0 2 2 0 014 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5 12h.01M19 12h.01" />
                </svg>
            </button>
        </div>

        <!-- Oblasť Správ -->
        <div id="chat-messages" class="chat-area flex-grow overflow-y-auto space-y-4 pr-2 mb-4">
            <!-- Úvodná správa -->
            <div class="flex justify-start">
                <!-- Pridaná trieda message-enter pre animáciu prvej správy -->
                <div class="bg-blue-600/50 glass-container p-3 rounded-xl rounded-tl-none max-w-3xl shadow-lg message-enter">
                    <p class="font-bold text-blue-200">ChatSlovak AI V5 Model</p>
                    <p class="text-white mt-1">Dobrý deň. Som pripravený na konverzáciu. Povedzte mi, ako vám môžem pomôcť, alebo mi zadajte príkaz 'napíš mi hororový príbeh'.</p>
                </div>
            </div>
            <!-- Správy budú pridané sem -->
        </div>

        <!-- Vstupná Oblasť -->
        <div class="flex space-x-3 glass-container p-3 rounded-xl">
            <!-- Odstránený 'disabled' atribút -->
            <input type="text" id="chat-input" placeholder="Napíšte svoju správu..." class="flex-grow p-3 rounded-lg bg-white/10 text-white border-none focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-white/50" onkeydown="if(event.key === 'Enter') sendMessage()">
            <!-- Odstránený 'disabled' atribút -->
            <button id="send-button" onclick="sendMessage()" class="bg-blue-500 hover:bg-blue-400 text-white font-bold py-3 px-6 rounded-xl transition duration-200 shadow-md flex items-center justify-center disabled:opacity-50">
                Odoslať
                <svg class="w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            </button>
        </div>
        
    </div>

    <!-- API Skripty (Firebase odstránené) -->
    <script type="module">
        
        // --- Konfigurácia pre prehliadačové prostredie ---
        // Generovanie lokálneho ID používateľa
        const userId = crypto.randomUUID(); 
        
        // --- Konštanty pre AI ---
        const API_KEY = "AIzaSyDdiCiIfr2gLtsRMENBkWG1hJo6N1uij7w";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        
        // --- Funkcie pre Hlasové Čítanie (TTS) ---
        let isSpeakingEnabled = false;
        
        // Nastaví ikonu a stav TTS
        function updateTtsButton() {
            const ttsButton = document.getElementById('tts-toggle');
            if (isSpeakingEnabled) {
                ttsButton.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                ttsButton.classList.add('bg-blue-500', 'hover:bg-blue-400');
                ttsButton.innerHTML = `Hlas: Zapnutý <svg class="w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15.414a2 2 0 01-2.828-2.828m0 0a2 2 0 012.828-2.828m-2.828 2.828L5.586 15.414z" /></svg>`;
            } else {
                ttsButton.classList.remove('bg-blue-500', 'hover:bg-blue-400');
                ttsButton.classList.add('bg-gray-700', 'hover:bg-gray-600');
                ttsButton.innerHTML = `Hlas: Vypnutý <svg class="w-5 h-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.586 15.414a2 2 0 01-2.828-2.828m0 0a2 2 0 012.828-2.828m-2.828 2.828L5.586 15.414zM10.15 4.54a2 2 0 013.7 0M8 8a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5 12h.01M19 12h.01" /></svg>`;
            }
        }
        
        window.toggleSpeaking = function() {
            isSpeakingEnabled = !isSpeakingEnabled;
            updateTtsButton();
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            if (isSpeakingEnabled) {
                speakText("Hlasová funkcia zapnutá.");
            }
        }

        function speakText(text) {
            if (isSpeakingEnabled && 'speechSynthesis' in window) {
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'sk-SK';
                
                // Načítanie hlasov a pokus o nájdenie slovenskej (sk) alebo českej (cs) hlasu
                const voices = window.speechSynthesis.getVoices();
                const slovakVoice = voices.find(voice => voice.lang.startsWith('sk'));
                const czechVoice = voices.find(voice => voice.lang.startsWith('cs'));
                const englishVoice = voices.find(voice => voice.lang.startsWith('en'));

                if (slovakVoice) {
                    utterance.voice = slovakVoice;
                } else if (czechVoice) {
                    utterance.voice = czechVoice;
                } else if (englishVoice) {
                    // Fallback to a common voice
                    utterance.voice = englishVoice;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // Zavolajte pri načítaní pre správnu ikonu
        updateTtsButton();

        // --- Funkcie pre Chat UI ---
        const chatArea = document.getElementById('chat-messages');
        const inputElement = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        function createMessageElement(sender, text, isStory = false) {
            const alignment = sender === 'user' ? 'justify-end' : 'justify-start';
            const bgColor = sender === 'user' ? 'bg-blue-500/80' : 'bg-blue-600/50';
            const senderName = sender === 'user' ? 'Vy' : 'ChatSlovak AI V5 Model';
            const roundStyle = sender === 'user' ? 'rounded-tr-none' : 'rounded-tl-none';
            const storyStyle = isStory ? 'border border-red-500 shadow-xl' : '';
            const textColor = isStory ? 'text-red-200' : (sender === 'user' ? 'text-white' : 'text-white');

            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${alignment}`;
            
            // --- NOVÉ: Pridaná trieda message-enter pre animáciu správy ---
            messageDiv.innerHTML = `
                <div class="${bgColor} glass-container p-4 rounded-xl ${roundStyle} max-w-3xl shadow-lg ${storyStyle} message-enter">
                    <p class="font-bold text-blue-200">${senderName}</p>
                    <div class="${textColor} mt-1 whitespace-pre-wrap">${text}</div>
                </div>
            `;
            // --- Koniec NOVÉHO kódu ---

            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function addLoadingIndicator(messageId, storyMode) {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = messageId;
            loadingDiv.className = 'flex justify-start';
            loadingDiv.innerHTML = `
                <div class="bg-gray-700/50 glass-container p-4 rounded-xl rounded-tl-none max-w-3xl shadow-lg flex items-center message-enter">
                    <div class="dot-pulse mr-4"></div>
                    <p class="text-white/70">${storyMode ? 'Generujem masívne hororový príbeh...' : 'ChatSlovak AI premýšľa...'}</p>
                </div>
            `;
            chatArea.appendChild(loadingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            return loadingDiv;
        }

        function removeLoadingIndicator(messageId) {
            const loadingDiv = document.getElementById(messageId);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // --- LLM API Handling ---
        
        async function callGeminiAPI(prompt, systemPrompt, tools, retries = 0) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            if (tools && tools.length > 0) {
                payload.tools = tools;
            }
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries < 3) {
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiAPI(prompt, systemPrompt, tools, retries + 1);
                    }
                    throw new Error(`API chyba: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Nastala chyba pri generovaní odpovede.";
                
                let sources = [];
                const groundingMetadata = result.candidates?.[0]?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                return { text, sources };

            } catch (error) {
                console.error("Chyba API volania:", error);
                return { text: "Prepáčte, nastala chyba pri komunikácii s AI. Skúste to prosím znova.", sources: [] };
            }
        }

        // --- Hlavná Funkcia Odoslania Správy ---
        window.sendMessage = async function() {
            const message = inputElement.value.trim();
            // userId je vždy nastavené, takže stačí skontrolovať správu
            if (!message) return; 

            // 1. Zobrazenie správy používateľa a vyčistenie vstupu
            createMessageElement('user', message);
            inputElement.value = '';
            
            // Dočasné zablokovanie vstupu počas generovania
            inputElement.disabled = true;
            sendButton.disabled = true;

            const isHorrorRequest = message.toLowerCase().includes('príbeh') || message.toLowerCase().includes('horor') || message.toLowerCase().includes('desivé') || message.toLowerCase().includes('strašidelný');
            
            // 2. Nastavenie režimu AI
            let systemPrompt;
            let tools;
            let postStoryCue = "";
            
            if (isHorrorRequest) {
                // Režim Hororového Generátora
                systemPrompt = "Si ChatSlovak AI V5 Model, v režime 'Masívny Hororový Generátor'. Tvojou úlohou je vygenerovať extrémne desivý, strašidelný a temný krátky príbeh (cca 250-400 slov). Zameraj sa na budovanie atmosféry, psychologický teror a nečakané zvraty. Použi bohatý, opisný jazyk, ktorý navodzuje pocit absolútneho strachu. Príbeh musí byť maximálne desivý. Názov príbehu je povinný. Odpovedaj výlučne v slovenčine.";
                tools = []; // Vypnutie Google Search pre kreatívne písanie
                postStoryCue = "Thanking...\n\n"; // Požiadavka užívateľa na špeciálny text
            } else {
                // Režim Normálnej Konverzácie
                systemPrompt = "Si ChatSlovak AI V5 Model, moderný a ochotný konverzačný partner. Tvoj tón je profesionálny, priateľský a mierne moderný/štýlový. Odpovedaj na otázky presne a použi vedomosti z Google Search, ak sú potrebné. Odpovedaj v slovenčine.";
                tools = [{ "google_search": {} }]; // Zapnutie Google Search pre bežné otázky
            }

            // 3. Zobrazenie indikátora načítania
            const loadingMessageId = `loading-${Date.now()}`;
            addLoadingIndicator(loadingMessageId, isHorrorRequest);

            // 4. API Volanie
            const geminiResult = await callGeminiAPI(message, systemPrompt, tools);

            // 5. Odstránenie indikátora načítania
            removeLoadingIndicator(loadingMessageId);

            // 6. Formátovanie a zobrazenie odpovede
            let fullResponseText = postStoryCue + geminiResult.text;
            
            createMessageElement('ai', fullResponseText, isHorrorRequest);
            
            // 7. Spustenie hlasového čítania
            speakText(fullResponseText);

            // 8. Obnovenie vstupu
            inputElement.disabled = false;
            sendButton.disabled = false;
            inputElement.focus();
        }
        
        // Exponovanie funkcie pre onclick v HTML
        window.toggleSpeaking = toggleSpeaking;
        window.sendMessage = sendMessage;
    </script>
</body>
</html>


